{% extends 'base.html' %}
{% load static %}

{% block title %}{{ page_title }} - プロジェクト管理{% endblock %}

{# ★★★ CSSはここへ ★★★ #}
{% block extra_css %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
    /* 円グラフ中心のテキスト位置付け（絶対配置） */
    .center-text {
        position: absolute;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%); /* 中央揃え */
        font-weight: bold;
        font-size: 1rem;
        text-align: center;
        pointer-events: none; /* クリックやホバーを邪魔しない */
        color: #333;
    }
    
    /* カードのスタイル調整 */
    .dashboard-card {
        transition: transform 0.2s;
        border-radius: 10px;
        border: 1px solid #e0e0e0;
        background-color: #fff;
    }
    .dashboard-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0,0,0,0.1);
    }
</style>
{% endblock %}


{# ★★★ HTML本文はここへ ★★★ #}
{% block content %}
<div class="container-fluid px-4 py-4">

    {% if user.role.code == 'manager' or user.role.code == 'admin' %}
        <h2 class="mb-4 text-center fw-bold text-primary">チームタスクダッシュボード</h2>
        
        <div class="row" id="dashboard"></div>

    {% else %}
        <section class="tasks-overview">
            <h2>持ちタスク</h2>
            <div class="alert alert-info">
                現在、一般社員用のダッシュボードは開発中です。<br>
                タスクボードまたはマイタスク画面をご確認ください。
            </div>
            </section>

    {% endif %}

</div>
{% endblock %}


{# ★★★ JavaScriptはここへ ★★★ #}
{% block extra_js %}
{% if user.role.code == 'manager' or user.role.code == 'admin' %}
<script>
/* Djangoから渡されたJSONデータを受け取る */
/* エディタでエラーが出る場合は const membersData = JSON.parse("{{ members_json|escapejs }}"); としてください */
const membersData = JSON.parse("{{ members_json|escapejs }}");

/* -----------------------------
   1. 期限カテゴリ判定関数 (条件を変更)
   - 0~3日以内
   - 4~7日以内
   - 8日以上 (それ以外)
------------------------------*/
function getDeadlineCategory(deadline) {
    if (!deadline) return "8日以上"; // 期限なし

    const today = new Date();
    today.setHours(0,0,0,0); // 時間は無視
    const d = new Date(deadline);
    
    // 日数差を計算
    const diffTime = d - today;
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

    if (diffDays <= 3) return "0-3日";
    else if (diffDays <= 7) return "4-7日";
    else return "8日以上";
}

/* -----------------------------
   2. カテゴリごとの色定義 (内側・外側で分岐)
------------------------------*/
function getDeadlineColor(cat, type) {
    if (type === 'request') {
        // ★内側（振られたタスク）
        switch (cat) {
            case "0-3日": return "#dc3545"; // 赤
            case "4-7日": return "#198754"; // 緑
            case "8日以上": return "#0d6efd"; // 青
            default: return "#e9ecef";
        }
    } else {
        // ★外側（自分のタスク）
        switch (cat) {
            case "0-3日": return "#fd7e14"; // オレンジ
            case "4-7日": return "#ffc107"; // 黄色
            case "8日以上": return "#e9ecef"; // 灰色
            default: return "#e9ecef";
        }
    }
}

/* カテゴリの並び順 */
const CATEGORY_ORDER = ["0-3日", "4-7日", "8日以上"];
const dashboard = document.getElementById("dashboard");

if (membersData && membersData.length > 0) {
    membersData.forEach(function (member) {
        
        // --- 基本的なカード構築 ---
        const col = document.createElement("div");
        col.className = "col-12 col-md-6 col-xl-3 d-flex"; 
        const card = document.createElement("div");
        card.className = "card w-100 mb-4 d-flex flex-column align-items-center p-3 dashboard-card";

        // メンバー情報
        const info = document.createElement("div");
        info.className = "text-center mb-2 w-100";
        info.innerHTML = `
            <h5 class="fw-bold mb-1">${member.name}</h5>
            <div class="small text-muted mb-2">等級: ${member.grade}</div>
        `;
        
        // スキルタグ
        const tagsDiv = document.createElement("div");
        tagsDiv.className = "d-flex flex-wrap gap-1 justify-content-center";
        if (member.skills && member.skills.length > 0) {
            member.skills.forEach(skill => {
                tagsDiv.innerHTML += `<span class="badge bg-light text-dark border">${skill}</span>`;
            });
        } else {
            tagsDiv.innerHTML = `<span class="badge bg-light text-muted border">-</span>`;
        }
        info.appendChild(tagsDiv);
        card.appendChild(info);

        // --- グラフ領域 ---
        const chartContainer = document.createElement("div");
        chartContainer.className = "position-relative w-100 d-flex justify-content-center mb-3 mt-3";
        chartContainer.style.maxWidth = "200px";
        chartContainer.style.height = "200px";
        const canvas = document.createElement("canvas");
        chartContainer.appendChild(canvas);
        card.appendChild(chartContainer);

        // --- データ集計 ---
        const taskData = member.tasks;

        function getCategoryCounts(dataList) {
            const map = {};
            CATEGORY_ORDER.forEach(cat => map[cat] = 0);
            dataList.forEach(t => {
                const cat = getDeadlineCategory(t.deadline);
                if (map.hasOwnProperty(cat)) map[cat]++;
            });
            return map;
        }

        const outerMap = getCategoryCounts(taskData.own);
        const innerMap = getCategoryCounts(taskData.request);

        // データ配列作成
        const outerData = CATEGORY_ORDER.map(cat => outerMap[cat]);
        const innerData = CATEGORY_ORDER.map(cat => innerMap[cat]);
        
        // ★色配列作成 (ここで 'own' / 'request' を指定して色を分ける)
        const outerColors = CATEGORY_ORDER.map(cat => getDeadlineColor(cat, 'own'));
        const innerColors = CATEGORY_ORDER.map(cat => getDeadlineColor(cat, 'request'));

        // --- グラフ描画 ---
        new Chart(canvas, {
            type: "doughnut",
            data: {
                labels: CATEGORY_ORDER,
                datasets: [
                    {
                        // 外側: 自作タスク (Own) -> オレンジ/黄/灰
                        data: outerData,
                        backgroundColor: outerColors,
                        cutout: "55%",
                        radius: "95%",
                        borderWidth: 2,
                        borderColor: "#ffffff"
                    },
                    {
                        // 内側: 依頼タスク (Request) -> 赤/緑/青
                        data: innerData,
                        backgroundColor: innerColors,
                        cutout: "30%",
                        radius: "100%",
                        borderWidth: 2,
                        borderColor: "#ffffff"
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,

                // ★★★ ここから追加：クリックイベント ★★★
                onClick: (e) => {
                    // マネージャーなら詳細画面へ遷移
                    // member.id は forEach のスコープにあるのでそのまま使えます
                    window.location.href = `/management/member/${member.id}/`;
                },
                // カーソルをポインター（指マーク）にする
                onHover: (event, chartElement) => {
                    event.native.target.style.cursor = chartElement[0] ? 'pointer' : 'default';
                },
                // ★★★ ここまで追加 ★★★
                
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function (context) {
                                const datasetIndex = context.datasetIndex;
                                const dataMap = datasetIndex === 0 ? outerMap : innerMap;
                                const typeName = datasetIndex === 0 ? "自作" : "依頼";
                                const category = CATEGORY_ORDER[context.dataIndex];
                                const count = dataMap[category] || 0;
                                return `${typeName}: ${count}件 (${category})`;
                            }
                        }
                    },
                    legend: { display: false }
                }
            }
        });

        // --- 中央テキスト ---
        const centerText = document.createElement("div");
        centerText.className = "center-text";
        const totalReq = taskData.request.length;
        const totalAll = taskData.own.length + taskData.request.length;
        
        centerText.innerHTML = `
            <div style="font-size:0.75rem; color:#888; line-height:1;">依頼</div>
            <div style="font-size:1.5rem; font-weight:800; line-height:1.1;">${totalReq}</div>
            <div style="font-size:0.8rem; color:#ccc;">/${totalAll}</div>
        `;
        chartContainer.appendChild(centerText);

        // --- 難易度表示 ---
        const diffDiv = document.createElement("div");
        diffDiv.className = "d-flex justify-content-center flex-wrap gap-2 w-100 small mt-2";
        const diffConfig = [
            {key: 'high', label: '高', color: 'text-danger'},
            {key: 'mid', label: '中', color: 'text-warning'},
            {key: 'low', label: '低', color: 'text-success'}
        ];
        diffConfig.forEach(conf => {
            const count = taskData.difficulty[conf.key] || 0;
            diffDiv.innerHTML += `<div class="px-2"><span class="fw-bold ${conf.color}">${conf.label}</span>: ${count}</div>`;
        });
        card.appendChild(diffDiv);
        col.appendChild(card);
        dashboard.appendChild(col);
    });
} else {
    dashboard.innerHTML = '<div class="col-12 text-center text-muted py-5">データがありません</div>';
}
</script>
{% endif %}
{% endblock %}