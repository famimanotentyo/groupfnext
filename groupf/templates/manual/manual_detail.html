{% extends 'base.html' %}
{% block title %}{{ manual.title }}{% endblock %}

{% block content %}
<div class="container" style="padding: 20px; max-width: 960px; margin: auto;">
  <h1>{{ manual.title }}</h1>
  
  <div class="card mb-4">
    <div class="card-body">
      <p class="text-muted">
        作成: {{ manual.created_by.username }} ({{ manual.created_at|date:"Y/m/d H:i" }}) |
        状態: {{ manual.status.name }}
      </p>
      {% if manual.description %}
        <div class="manual-description">
          {{ manual.description|linebreaks }}
        </div>
      {% endif %}
      
      {% if manual.file %}
        <div class="mt-3">
          <h5>メインファイル</h5>
          <a href="{{ manual.file.url }}" class="btn btn-primary" target="_blank">
            ファイルを開く
          </a>
        </div>
      {% endif %}
    </div>
  </div>

  <div class="card mb-4">
    <div class="card-header">
      添付ファイル
    </div>
    <div class="card-body">
      <form method="post" enctype="multipart/form-data" action="{% url 'manual_files_upload' manual.id %}" class="mb-4">
        {% csrf_token %}
        <div class="input-group">
            {{ upload_form.files }}
            <button type="submit" class="btn btn-success">ファイル投稿</button>
        </div>
      </form>

      <ul class="list-group">
        {% for f in files %}
          <li class="list-group-item">
            <div class="d-flex justify-content-between align-items-center">
                <a href="{% url 'manual_file_view' f.id %}" target="_blank" rel="noopener">
                {{ f.original_name|default:f.file.name }}
                </a>
                <small class="text-muted">{{ f.uploaded_at|date:"Y/m/d H:i" }}</small>
            </div>

            {% if f.file.name|lower|slice:"-4:" == ".pdf" %}
              <div class="mt-2">
                  <iframe src="{% url 'manual_file_view' f.id %}" style="width:100%; height:600px; border: 1px solid #ddd;"></iframe>
              </div>
            {% endif %}
          </li>
        {% empty %}
          <li class="list-group-item text-muted">まだファイルが投稿されていません</li>
        {% endfor %}
      </ul>
    </div>
  </div>

  <div class="d-flex justify-content-between mt-4">
    <a href="{% url 'manual_list' %}" class="btn btn-secondary">一覧に戻る</a>
    
    {% if request.user.role.code in 'manager,admin' and manual.status.code == 'pending' %}
    <form action="{% url 'manual_approval_list' %}" method="get" style="display:inline;">
        <input type="hidden" name="manual_id" value="{{ manual.id }}">
        <button type="submit" class="btn btn-warning">承認して公開する</button>
    </form>
    {% endif %}

     <a href="{% url 'toggle_manual_favorite' manual.id %}" class="btn btn-outline-primary">
        {% if request.user in manual.bookmarks.all %}
            ブックマーク解除
        {% else %}
            ブックマーク
        {% endif %}
    </a>
  </div>
</div>
{% endblock %}