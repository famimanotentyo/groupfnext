{% extends 'base.html' %}

{% block content %}
<div class="container py-4" style="max-width: 800px;">
    <div class="card mb-3 border-0 shadow-sm">
        <div class="card-body d-flex justify-content-between align-items-center bg-light rounded">
            <div>
                <h4 class="fw-bold mb-1">{{ consultation.title }}</h4>
                <div class="text-muted small">
                    参加者: <span class="fw-bold">{{ consultation.requester.last_name }}</span> & <span class="fw-bold">{{ consultation.respondent.last_name }}</span>
                </div>
            </div>
            
            {% if consultation.status.code != 'resolved' %}
                <form method="post" action="{% url 'consultation_resolve' pk=consultation.pk %}" onsubmit="return confirm('解決済みにしますか？\n会話履歴からAIがナレッジを自動生成します。');">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-check me-1"></i>解決してナレッジ化
                    </button>
                </form>
            {% else %}
                <span class="badge bg-secondary px-3 py-2">解決済み</span>
            {% endif %}
        </div>
    </div>

    <div class="card shadow-sm mb-4">
        <div class="card-body bg-light" style="height: 500px; overflow-y: auto;" id="chat-box">
            {% for msg in messages_list %}
                {% if msg.sender == request.user %}
                    <div class="d-flex justify-content-end mb-3">
                        <div class="text-end" style="max-width: 70%;">
                            <div class="bg-primary text-white p-3 rounded-3 shadow-sm text-start" style="border-bottom-right-radius: 0 !important;">
                                {{ msg.content|linebreaksbr }}
                            </div>
                            <small class="text-muted" style="font-size: 0.75rem;">{{ msg.created_at|date:"H:i" }}</small>
                        </div>
                    </div>
                {% else %}
                    <div class="d-flex justify-content-start mb-3">
                        <div class="text-start" style="max-width: 70%;">
                            <div class="bg-white text-dark p-3 rounded-3 shadow-sm border" style="border-bottom-left-radius: 0 !important;">
                                {{ msg.content|linebreaksbr }}
                            </div>
                            <small class="text-muted ms-1" style="font-size: 0.75rem;">
                                {{ msg.sender.last_name }} - {{ msg.created_at|date:"H:i" }}
                            </small>
                        </div>
                    </div>
                {% endif %}
            {% empty %}
                <div class="text-center text-muted py-5">
                    まだメッセージはありません。<br>相談内容を送ってみましょう。
                </div>
            {% endfor %}
        </div>
    </div>

    {% if consultation.status.code != 'resolved' %}
        <div class="card shadow-sm">
            <div class="card-body">
                <form method="post">
                    {% csrf_token %}
                    <div class="input-group">
                        {{ form.content }}
                        <button type="submit" class="btn btn-primary px-4">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    {% else %}
        <div class="alert alert-secondary text-center">
            この相談は解決済みのため、メッセージを送信できません。
        </div>
    {% endif %}
</div>

<script>
    // ページ読み込み時にチャットの一番下までスクロール
    window.onload = function() {
        var chatBox = document.getElementById('chat-box');
        chatBox.scrollTop = chatBox.scrollHeight;
    };
</script>
{% endblock %}