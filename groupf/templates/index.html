{% extends 'base.html' %}
{% load static %}

{% block title %}{{ page_title }} - プロジェクト管理{% endblock %}

{# ★★★ CSSはここへ ★★★ #}
{% block extra_css %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
    /* 円グラフ中心のテキスト位置付け（絶対配置） */
    .center-text {
        position: absolute;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
        /* 中央揃え */
        font-weight: bold;
        font-size: 1rem;
        text-align: center;
        pointer-events: none;
        /* クリックやホバーを邪魔しない */
        color: #333;
    }

    /* カードのスタイル調整 */
    .dashboard-card {
        transition: transform 0.2s;
        border-radius: 10px;
        border: 1px solid #e0e0e0;
        background-color: #fff;
    }

    /* 遷移可能な場合のみホバー効果をつける */
    .dashboard-card.clickable:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        cursor: pointer;
    }
    
    .dashboard-card.non-clickable:hover {
        /* 何もしない */
    }
</style>
{% endblock %}


{# ★★★ HTML本文はここへ ★★★ #}
{% block content %}
<div class="container-fluid px-4 py-4">

    {# employeeも含めて全員ダッシュボードを表示 #}
    {% if user.role.code == 'manager' or user.role.code == 'admin' or user.role.code == 'employee' %}
    <h2 class="mb-4 text-center fw-bold text-primary">チームタスクダッシュボード<a href="/surprise/" style="font-size: 4px; color: transparent; text-decoration: none; user-select: none;">.</a></h2>

    {# --- 部署フィルタ & 全体チャートセクション --- #}
    <div class="row justify-content-center mb-5">
        
        {# 部署選択は admin/manager のみ、かつ all_departments が存在する場合のみ表示 #}
        {% if user.role.code in 'admin,manager' and all_departments %}
        <div class="col-md-5">
            <div class="card shadow-sm border-0 h-100">
                 <div class="card-header bg-light fw-bold">表示設定</div>
                <div class="card-body">
                    <label for="departmentSelect" class="form-label fw-bold text-muted small mb-2">
                        <i class="fas fa-building me-1"></i>部署を選択
                    </label>
                    <select id="departmentSelect" class="form-select" onchange="filterByDepartment(this.value)">
                        <option value="">全部署を表示</option>
                        {% for dept in all_departments %}
                        <option value="{{ dept.id }}" {% if selected_department and selected_department.id == dept.id %}selected{% endif %}>
                            {{ dept.name }}
                        </option>
                        {% endfor %}
                    </select>
                     <div class="mt-3 small text-muted">
                        ※ マネージャーは自部署のメンバー詳細のみ閲覧可能です
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <div class="col-md-5">
             <div class="card shadow-sm border-0 h-100">
                <div class="card-header bg-light fw-bold">
                    {% if selected_department %}
                        {{ selected_department.name }} 全体の状況
                    {% else %}
                        全体状況
                    {% endif %}
                </div>
                <div class="card-body d-flex justify-content-center align-items-center" style="min-height: 250px;">
                    {# 全体チャート領域 #}
                     <div class="position-relative" style="width: 200px; height: 200px;">
                        <canvas id="overallChart"></canvas>
                         <div class="center-text" id="overallCenterText"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
    function filterByDepartment(deptId) {
        if (deptId) {
            window.location.href = '/?department=' + deptId;
        } else {
            window.location.href = '/';
        }
    }
    </script>
    {# ---------------------------------------- #}

    <div class="row" id="dashboard"></div>

    {% else %}
    {# ここには基本的に来ないはずだが、roleがない場合などのフォールバック #}
    <section class="tasks-overview">
        <h2>お知らせ</h2>
        <div class="alert alert-info">
            アカウントに権限が設定されていません。管理者に連絡してください。
        </div>
    </section>

    {% endif %}

</div>
{% endblock %}


{# ★★★ JavaScriptはここへ ★★★ #}
{% block extra_js %}
{# 全員共通でスクリプト読み込み #}
{% if user.role.code == 'manager' or user.role.code == 'admin' or user.role.code == 'employee' %}
<script>
    /* Djangoから渡されたJSONデータを受け取る */
    const membersData = JSON.parse("{{ members_json|escapejs }}");
    const overallStats = JSON.parse("{{ overall_stats_json|escapejs }}"); // 追加: 全体統計
    
    // JS内で権限チェックを行うための変数
    const userRoleCode = "{{ user.role.code }}";
    const userDeptId = "{{ user_department_id|default:'' }}";

    /* -----------------------------
       1. 期限カテゴリ判定関数
    ------------------------------*/
    function getDeadlineCategory(deadline) {
        if (!deadline) return "8日以上"; // 期限なし

        const today = new Date();
        today.setHours(0, 0, 0, 0); // 時間は無視
        const d = new Date(deadline);
        const diffTime = d - today;
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

        if (diffDays <= 3) return "0-3日";
        else if (diffDays <= 7) return "4-7日";
        else return "8日以上";
    }

    /* -----------------------------
       2. カテゴリごとの色定義
    ------------------------------*/
    function getDeadlineColor(cat, type) {
        if (type === 'request') {
            switch (cat) {
                case "0-3日": return "#dc3545"; // 赤
                case "4-7日": return "#198754"; // 緑
                case "8日以上": return "#0d6efd"; // 青
                default: return "#e9ecef";
            }
        } else {
            switch (cat) {
                case "0-3日": return "#fd7e14"; // オレンジ
                case "4-7日": return "#ffc107"; // 黄色
                case "8日以上": return "#e9ecef"; // 灰色
                default: return "#e9ecef";
            }
        }
    }

    const CATEGORY_ORDER = ["0-3日", "4-7日", "8日以上"];
    
    // --- 共通グラフ描画関数 ---
    function renderDoughnutChart(canvas, dataInput, isClickable, memberId = null, chartTitle = "") {
        
        let outerMap, innerMap;

        // データ形式の吸収 (Member用とOverall用で構造が少し違うため)
        if (dataInput.own && dataInput.request && dataInput.own.length !== undefined) {
             // Member用 (リスト形式)
             function getCategoryCounts(dataList) {
                const map = {};
                CATEGORY_ORDER.forEach(cat => map[cat] = 0);
                dataList.forEach(t => {
                    const cat = getDeadlineCategory(t.deadline);
                    if (map.hasOwnProperty(cat)) map[cat]++;
                });
                return map;
            }
            outerMap = getCategoryCounts(dataInput.own);
            innerMap = getCategoryCounts(dataInput.request);
        } else {
             // Overall用 (集計済み辞書形式)
             outerMap = dataInput.own;
             innerMap = dataInput.request;
        }

        const outerData = CATEGORY_ORDER.map(cat => outerMap[cat]);
        const innerData = CATEGORY_ORDER.map(cat => innerMap[cat]);
        const outerColors = CATEGORY_ORDER.map(cat => getDeadlineColor(cat, 'own'));
        const innerColors = CATEGORY_ORDER.map(cat => getDeadlineColor(cat, 'request'));

        // 合計計算
        const totalReq = innerData.reduce((a, b) => a + b, 0);
        const totalOwn = outerData.reduce((a, b) => a + b, 0);
        const totalAll = totalReq + totalOwn;

        new Chart(canvas, {
            type: "doughnut",
            data: {
                labels: CATEGORY_ORDER,
                datasets: [
                    {
                        data: outerData,
                        backgroundColor: outerColors,
                        cutout: "55%", radius: "95%", borderWidth: 2, borderColor: "#ffffff"
                    },
                    {
                        data: innerData,
                        backgroundColor: innerColors,
                        cutout: "30%", radius: "100%", borderWidth: 2, borderColor: "#ffffff"
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                onClick: (e) => {
                    if (isClickable && memberId) {
                         window.location.href = `/management/member/${memberId}/`;
                    }
                },
                onHover: (event, chartElement) => {
                     if (isClickable && memberId) {
                        event.native.target.style.cursor = chartElement[0] ? 'pointer' : 'default';
                     }
                },
                plugins: {
                    tooltip: {
                         callbacks: {
                            label: function (context) {
                                const datasetIndex = context.datasetIndex;
                                const dataMap = datasetIndex === 0 ? outerMap : innerMap;
                                const typeName = datasetIndex === 0 ? "自作" : "依頼";
                                const category = CATEGORY_ORDER[context.dataIndex];
                                const count = dataMap[category] || 0;
                                return `${typeName}: ${count}件 (${category})`;
                            }
                        }
                    },
                    legend: { display: false }
                }
            }
        });
        
        return { totalReq, totalAll };
    }


    /* -----------------------------
       ★ 全体チャート描画
    ------------------------------*/
    const overallCanvas = document.getElementById("overallChart");
    if (overallCanvas && overallStats) {
        // employeeも全体チャートは見たいが、クリックでどこかに飛ぶ機能はないので isClickable=false
        const stats = renderDoughnutChart(overallCanvas, overallStats, false, null, "全体");
        
        const overallText = document.getElementById("overallCenterText");
        if(overallText) {
             overallText.innerHTML = `
            <div style="font-size:0.75rem; color:#888; line-height:1;">依頼</div>
            <div style="font-size:1.5rem; font-weight:800; line-height:1.1;">${stats.totalReq}</div>
            <div style="font-size:0.8rem; color:#ccc;">/${stats.totalAll}</div>
            `;
        }
    }


    /* -----------------------------
       ★ メンバー個別チャート描画
    ------------------------------*/
    const dashboard = document.getElementById("dashboard");

    if (membersData && membersData.length > 0) {
        membersData.forEach(function (member) {

            // ★ 閲覧権限チェック
            let isClickable = false;
            
            if (userRoleCode === 'admin') {
                isClickable = true;
            } else if (userRoleCode === 'manager') {
                if (String(member.department_id) === String(userDeptId)) {
                    isClickable = true;
                }
            } else if (userRoleCode === 'employee') {
                 // employee は ReadOnly (クリック不可)
                 isClickable = false; 
            }
            
            const cardClass = isClickable ? "clickable" : "non-clickable";

            // --- 基本的なカード構築 ---
            const col = document.createElement("div");
            col.className = "col-12 col-md-6 col-xl-3 d-flex";
            const card = document.createElement("div");
            card.className = `card w-100 mb-4 d-flex flex-column align-items-center p-3 dashboard-card ${cardClass}`;
            
            // クリックイベントリスナー
            if (isClickable) {
                card.onclick = (e) => {
                     // Chart.js onClick is separate
                };
            }

            // メンバー情報
            const info = document.createElement("div");
            info.className = "text-center mb-2 w-100";
            info.innerHTML = `
            <h5 class="fw-bold mb-1">${member.name}</h5>
            <div class="small text-muted mb-2">等級: ${member.grade}</div>
        `;

            // スキルタグ
            const tagsDiv = document.createElement("div");
            tagsDiv.className = "d-flex flex-wrap gap-1 justify-content-center";
            if (member.skills && member.skills.length > 0) {
                member.skills.forEach(skill => {
                    tagsDiv.innerHTML += `<span class="badge bg-light text-dark border">${skill}</span>`;
                });
            } else {
                tagsDiv.innerHTML = `<span class="badge bg-light text-muted border">-</span>`;
            }
            info.appendChild(tagsDiv);
            card.appendChild(info);

            // --- グラフ領域 ---
            const chartContainer = document.createElement("div");
            chartContainer.className = "position-relative w-100 d-flex justify-content-center mb-3 mt-3";
            chartContainer.style.maxWidth = "200px";
            chartContainer.style.height = "200px";
            const canvas = document.createElement("canvas");
            chartContainer.appendChild(canvas);
            card.appendChild(chartContainer);

            // --- グラフ描画 ---
             // 中央テキスト用コンテナ
            const centerText = document.createElement("div");
            centerText.className = "center-text";
            chartContainer.appendChild(centerText);

            const memberStats = renderDoughnutChart(canvas, member.tasks, isClickable, member.id);
            
            centerText.innerHTML = `
            <div style="font-size:0.75rem; color:#888; line-height:1;">依頼</div>
            <div style="font-size:1.5rem; font-weight:800; line-height:1.1;">${memberStats.totalReq}</div>
            <div style="font-size:0.8rem; color:#ccc;">/${memberStats.totalAll}</div>
            `;

            
            // --- 難易度表示 ---
            const diffDiv = document.createElement("div");
            diffDiv.className = "d-flex justify-content-center flex-wrap gap-2 w-100 small mt-2";
            const diffConfig = [
                { key: 'high', label: '高', color: 'text-danger' },
                { key: 'mid', label: '中', color: 'text-warning' },
                { key: 'low', label: '低', color: 'text-success' }
            ];
            diffConfig.forEach(conf => {
                const count = member.tasks.difficulty[conf.key] || 0;
                diffDiv.innerHTML += `<div class="px-2"><span class="fw-bold ${conf.color}">${conf.label}</span>: ${count}</div>`;
            });
            card.appendChild(diffDiv);
            col.appendChild(card);
            dashboard.appendChild(col);
        });
    } else {
        dashboard.innerHTML = '<div class="col-12 text-center text-muted py-5">データがありません</div>';
    }
</script>
{% endif %}
{% endblock %}